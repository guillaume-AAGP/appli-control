<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expert Programmatiste - Pujol Archi 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .checkbox-custom:checked + label { text-decoration: line-through; color: #9ca3af; }
        .tab-active { border-bottom: 4px solid #10b981; color: #10b981; font-weight: 800; }
        input:focus, textarea:focus, select:focus { border-color: #10b981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1); outline: none; }
        
        .btn-action { transition: all 0.2s ease; }
        .btn-action:hover { transform: translateY(-1px); filter: brightness(1.05); }
        .btn-action:active { transform: scale(0.98); }

        .control-item { @apply flex flex-col gap-3 p-5 bg-white rounded-2xl border border-slate-200 hover:border-emerald-200 transition-all; }
        .note-field { @apply w-full text-xs bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 outline-none focus:border-emerald-500 transition-all; }
        
        .tracking-card { @apply bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-xl hover:shadow-slate-200/50 transition-all cursor-pointer border-l-8; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-32">

    <!-- Header -->
    <header class="bg-slate-900 text-white sticky top-0 z-50 shadow-xl">
        <div class="max-w-6xl mx-auto py-4 px-6 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-emerald-500 rounded-lg flex items-center justify-center font-black text-slate-900 shadow-lg">P</div>
                <div>
                    <h1 class="text-lg font-bold tracking-tight uppercase leading-none">Pujol Architecture</h1>
                    <p class="text-[10px] text-emerald-400 font-bold tracking-widest uppercase mt-1">Expert Programmatiste</p>
                </div>
            </div>
            <div class="flex items-center gap-6">
                <div class="text-right hidden sm:block mr-4">
                    <p class="text-[9px] uppercase text-slate-500 font-bold tracking-widest">Avancement Audit</p>
                    <div class="flex items-center gap-3 mt-1">
                        <div class="w-24 h-2 bg-slate-800 rounded-full overflow-hidden">
                            <div id="progress-bar" class="h-full bg-emerald-500 transition-all duration-700 w-0"></div>
                        </div>
                        <span id="progress-text" class="text-sm font-mono text-emerald-400 font-bold">0%</span>
                    </div>
                </div>
                <button onclick="createNewDossier()" class="hidden sm:flex items-center gap-2 bg-emerald-500/10 text-emerald-400 border border-emerald-500/30 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wider hover:bg-emerald-50 hover:text-white transition-all">
                    + Nouveau Dossier
                </button>
            </div>
        </div>
        
        <!-- Navigation -->
        <nav class="bg-slate-800/50 backdrop-blur-md border-t border-slate-700">
            <div class="max-w-6xl mx-auto flex overflow-x-auto">
                <button onclick="switchTab('tab-infos')" id="btn-infos" class="flex-1 min-w-[120px] py-4 text-[10px] font-bold uppercase tracking-widest text-slate-400 transition-all tab-active">
                    1. Audit Projet
                </button>
                <button onclick="switchTab('tab-controle')" id="btn-controle" class="flex-1 min-w-[120px] py-4 text-[10px] font-bold uppercase tracking-widest text-slate-400 transition-all">
                    2. Faisabilité
                </button>
                <button onclick="switchTab('tab-suivi')" id="btn-suivi" class="flex-1 min-w-[120px] py-4 text-[10px] font-bold uppercase tracking-widest text-slate-400 transition-all">
                    3. Suivi Dossiers
                </button>
            </div>
        </nav>
    </header>

    <main class="max-w-6xl mx-auto px-4 mt-8">

        <!-- ONGLET 1 : AUDIT -->
        <div id="tab-infos" class="tab-content space-y-6">
            <section class="bg-white rounded-3xl shadow-sm border border-slate-200 p-8">
                <div class="flex items-center gap-3 mb-8">
                    <div class="w-2 h-8 bg-emerald-500 rounded-full"></div>
                    <h2 class="text-xl font-bold text-slate-800">Identification du dossier</h2>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="md:col-span-2">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Nom du Projet</label>
                        <input type="text" id="proj-name" oninput="saveCurrentAudit()" placeholder="Ex: Villa Horizon - Gordes" class="w-full border-slate-100 border-2 rounded-2xl px-5 py-4 bg-slate-50 font-semibold text-slate-700">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-emerald-600 uppercase mb-2">Numéro de Dossier</label>
                        <input type="text" id="proj-dossier" oninput="saveCurrentAudit()" placeholder="Ex: PC-084-..." class="w-full border-emerald-100 border-2 rounded-2xl px-5 py-4 bg-white font-mono font-bold text-lg text-emerald-700 uppercase">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Salarié / Expert Référent</label>
                        <input type="text" id="proj-agent" oninput="saveCurrentAudit()" placeholder="Prénom & Nom" class="w-full border-slate-100 border-2 rounded-2xl px-5 py-4 bg-slate-50">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Surface de Plancher (SdP)</label>
                        <input type="text" id="proj-sdp" oninput="saveCurrentAudit()" placeholder="m²" class="w-full border-slate-100 border-2 rounded-2xl px-5 py-4 bg-slate-50">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Date de l'audit</label>
                        <input type="date" id="proj-date" oninput="saveCurrentAudit()" class="w-full border-slate-100 border-2 rounded-2xl px-5 py-4 bg-slate-50">
                    </div>
                </div>
            </section>

            <section class="bg-white rounded-3xl shadow-sm border border-slate-200 p-8">
                <h2 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-4">Note de Synthèse Générale</h2>
                <textarea id="notes" oninput="saveCurrentAudit()" rows="4" placeholder="Points de vigilance, faisabilité technique..." class="w-full border-slate-100 border-2 rounded-2xl px-5 py-4 bg-slate-50 text-sm"></textarea>
            </section>
        </div>

        <!-- ONGLET 2 : FAISABILITÉ -->
        <div id="tab-controle" class="tab-content hidden space-y-12">
            <div class="space-y-6">
                <h3 class="text-sm font-black text-indigo-500 uppercase tracking-widest flex items-center gap-3 ml-2">
                    <span class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-xs">01</span>
                    Auto-Contrôle (Foncier)
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="section-ac"></div>
            </div>

            <div class="space-y-6">
                <h3 class="text-sm font-black text-emerald-600 uppercase tracking-widest flex items-center gap-3 ml-2">
                    <span class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center text-xs">02</span>
                    Dossier Administratif (PC/AT/DP)
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="section-pc"></div>
            </div>

            <!-- Actions de Faisabilité -->
            <div class="pt-8 pb-12 space-y-4">
                <button onclick="exportCurrentToExcel()" class="w-full flex items-center justify-center gap-3 bg-white border-2 border-emerald-500 text-emerald-600 py-6 rounded-3xl font-black uppercase text-sm tracking-widest hover:bg-emerald-50 transition-all shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    Exporter l'Audit en Excel (.csv)
                </button>

                <button onclick="validateAndArchive()" class="btn-action w-full bg-slate-900 text-white py-12 rounded-[2.5rem] font-black text-2xl uppercase tracking-widest shadow-2xl flex flex-col items-center justify-center gap-4 border-b-8 border-emerald-600">
                    <div class="flex items-center gap-5">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                        </svg>
                        VALIDER & TOUT ENREGISTRER
                    </div>
                    <span class="text-[10px] font-bold text-slate-500 tracking-[0.3em]">ENREGISTREMENT PC + DRIVE + MAIL</span>
                </button>
                <div class="text-center">
                    <p class="text-[9px] text-slate-400 uppercase font-bold tracking-widest">Sauvegarde Drive Directe : <a href="https://drive.google.com/drive/folders/1f4kJQj3CJIKSzggXc36FxPJ0jbDdDS8d?usp=drive_link" target="_blank" class="text-indigo-500 hover:underline">Accéder au dossier</a></p>
                </div>
            </div>
        </div>

        <!-- ONGLET 3 : SUIVI DES DOSSIERS -->
        <div id="tab-suivi" class="tab-content hidden space-y-8">
            <!-- Drive Backup Banner -->
            <div class="bg-indigo-600 rounded-3xl p-6 text-white shadow-lg flex flex-col md:flex-row justify-between items-center gap-4 border border-indigo-400">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" /></svg>
                    </div>
                    <div>
                        <h4 class="font-bold text-sm uppercase tracking-wider">Espace de Sauvegarde Drive</h4>
                        <p class="text-xs text-indigo-100">Déposez vos rapports et documents dans le dossier partagé</p>
                    </div>
                </div>
                <a href="https://drive.google.com/drive/folders/1f4kJQj3CJIKSzggXc36FxPJ0jbDdDS8d?usp=drive_link" target="_blank" class="bg-white text-indigo-600 px-6 py-3 rounded-xl font-bold text-xs uppercase tracking-widest hover:bg-indigo-50 transition-colors shadow-md flex items-center gap-2">
                    Ouvrir le Drive
                </a>
            </div>

            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-black text-slate-800 uppercase tracking-tighter">Suivi des Dossiers</h2>
                    <p class="text-sm text-slate-500 font-medium">Historique et suivi des instructions administratives</p>
                </div>
                <div id="stats-suivi" class="flex gap-4"></div>
            </div>

            <div id="suivi-list" class="space-y-4"></div>

            <!-- ZONE D'ÉDITION DE SUIVI -->
            <div id="suivi-editor" class="hidden bg-white border border-slate-200 rounded-[2.5rem] p-8 sm:p-12 shadow-2xl relative overflow-hidden mb-12">
                <div class="absolute top-0 right-0 p-8">
                    <button onclick="closeSuiviEditor()" class="text-slate-400 hover:text-slate-900 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>

                <div class="mb-10 flex items-center gap-4">
                    <div class="w-12 h-12 bg-emerald-500 rounded-2xl flex items-center justify-center text-white font-black text-xl">S</div>
                    <div>
                        <span id="edit-id-label" class="text-[10px] font-bold text-emerald-500 uppercase tracking-[0.3em]">Édition du Suivi</span>
                        <h3 id="edit-name" class="text-3xl font-black uppercase text-slate-800 leading-tight">Nom du Dossier</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
                    <!-- Section A : Identification & Contrôle -->
                    <div class="space-y-5">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2">Identification & Validation</p>
                        <div>
                            <label class="block text-[10px] text-slate-400 font-bold uppercase mb-2">Réalisé par</label>
                            <input type="text" id="edit-agent" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl px-4 py-3 text-sm font-semibold" readonly>
                        </div>
                        <div class="flex items-center gap-3 bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                            <input type="checkbox" id="edit-manager-control" class="h-6 w-6 rounded bg-white border-emerald-300 text-emerald-500">
                            <label for="edit-manager-control" class="text-xs font-bold uppercase text-emerald-700">Contrôle Direction OK</label>
                        </div>
                    </div>

                    <!-- Section B : Instruction & Dépôts -->
                    <div class="space-y-5">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2">Instruction & Dépôts</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] text-slate-400 font-bold uppercase mb-2">Dépôt Estimé</label>
                                <input type="date" id="edit-date-estim" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl px-3 py-2 text-xs">
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-400 font-bold uppercase mb-2">Dépôt Réel</label>
                                <input type="date" id="edit-date-reel" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl px-3 py-2 text-xs">
                            </div>
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-400 font-bold uppercase mb-2">Numéro de dépôt</label>
                            <input type="text" id="edit-num-depot" placeholder="Ex: PC 084..." class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl px-4 py-3 text-sm">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-400 font-bold uppercase mb-2">Délais de réalisation</label>
                            <input type="text" id="edit-delai-real" placeholder="Ex: 15 jours" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl px-4 py-3 text-sm">
                        </div>
                    </div>

                    <!-- Section C : Pièces Complémentaires -->
                    <div class="space-y-5">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2">Pièces Complémentaires</p>
                        <div class="flex items-center gap-3 bg-orange-50 p-3 rounded-xl border border-orange-100">
                            <input type="checkbox" id="edit-pc-req" class="h-5 w-5 rounded bg-white border-orange-300 text-orange-500">
                            <label for="edit-pc-req" class="text-[10px] font-bold uppercase text-orange-700">Pièces compl. demandées</label>
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-400 font-bold uppercase mb-2">Délai réalisation PC</label>
                            <input type="text" id="edit-pc-delai" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl px-4 py-3 text-xs">
                        </div>
                        <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-slate-100">
                            <input type="checkbox" id="edit-pc-control" class="h-5 w-5 rounded bg-white border-slate-300 text-emerald-500">
                            <label for="edit-pc-control" class="text-[10px] font-bold uppercase text-slate-600">Contrôle des pièces OK</label>
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-400 font-bold uppercase mb-2">Date dépôt pièces</label>
                            <input type="date" id="edit-pc-date" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl px-3 py-2 text-xs">
                        </div>
                    </div>

                    <!-- Section D : Verdict Final -->
                    <div class="md:col-span-2 lg:col-span-3 space-y-6">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2">Verdict & Observations</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-[10px] text-slate-400 font-bold uppercase mb-2">Délais d'instruction</label>
                                    <input type="text" id="edit-instruction-delai" placeholder="Ex: 3 mois" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl px-4 py-3 text-sm">
                                </div>
                                <div class="flex items-center gap-5 bg-emerald-500 text-white p-6 rounded-2xl shadow-lg shadow-emerald-500/20">
                                    <input type="checkbox" id="edit-granted" class="h-8 w-8 rounded bg-white border-transparent text-emerald-600">
                                    <label for="edit-granted" class="text-lg font-black uppercase tracking-tight">DEMANDE ACCORDÉE</label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-400 font-bold uppercase mb-2">Remarques Dossier</label>
                                <textarea id="edit-remarks" rows="5" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-4 text-sm text-slate-700"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-12 pt-8 border-t border-slate-100 flex flex-col sm:flex-row gap-4">
                    <button onclick="saveSuiviEdition()" class="flex-1 bg-slate-900 text-white py-5 rounded-2xl font-black uppercase tracking-widest hover:bg-emerald-500 transition-all shadow-xl">
                        Enregistrer les modifications
                    </button>
                    <button onclick="deleteDossier()" class="px-8 py-5 text-red-500 font-bold uppercase text-[10px] tracking-widest hover:bg-red-50 rounded-2xl transition-all">
                        Supprimer le dossier
                    </button>
                </div>
            </div>

            <!-- EXPORT RÉCAPITULATIF EXCEL -->
            <div class="pt-12 flex flex-col items-center gap-6 border-t border-slate-200">
                <button onclick="exportToExcel()" class="flex items-center gap-3 bg-white border-2 border-slate-900 px-8 py-4 rounded-2xl text-slate-900 font-black uppercase text-xs tracking-[0.2em] hover:bg-slate-900 hover:text-white transition-all shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    Exporter le récapitulatif Global (.csv)
                </button>
                <p class="text-[9px] text-slate-400 uppercase font-bold tracking-widest text-center">Toutes les données sont accessibles dans le dossier partagé Drive</p>
            </div>
        </div>
    </main>

    <!-- UI Feedback Toast -->
    <div id="toast" class="fixed inset-0 bg-slate-900/95 backdrop-blur-md z-[100] flex items-center justify-center opacity-0 pointer-events-none transition-all duration-500">
        <div class="text-center text-white p-8 max-w-md">
            <div id="toast-icon" class="w-20 h-20 bg-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6 animate-pulse">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-slate-900" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg>
            </div>
            <h2 id="toast-title" class="text-3xl font-black uppercase tracking-tighter mb-4">Traitement en cours</h2>
            <p id="toast-message" class="text-slate-400 font-medium leading-relaxed"></p>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const pointsAC = [
            "Recherche de la parcelle sur cadastre.gouv et export d'un extrait de plan",
            "S'informer sur la surface de la parcelle",
            "Rechercher la parcelle sur google earth",
            "Recherche sur la parcelle sur géoportail de l'urbanisme et exporter l'ensemble du règlement (cartes, annexes, OAP, règlement écrit, etc…)",
            "Chercher la zone urbaine et du type de projet",
            "Contrôler le secteur de mixité sociale",
            "Vérifier si la parcelle est concerné par un emplacement réservé",
            "Vérifier si la parcelle se trouve dans un secteur ABF",
            "Vérifier si un espace vert à protéger / espace boisé classé se trouve sur la parcelle",
            "Controler le risque inondation",
            "Contrôler le risque feu de forêt",
            "Contrôler les risques technologique éventuels",
            "Contrôler les risques mouvements de terrains et argile",
            "Vérifier le zonage pluvial si il y en a un",
            "Contrôler les servitudes d'utilité publique (Gaz, Canal de Provence, etc…)",
            "Analyser les dispositions générales du règlement",
            "Analyser le règlement de la zone (emprise au sol, hauteur, espaces verts, etc…)",
            "Vérifier la bonne échelle du plan cadastral inséré sur Archicad",
            "Règlement de lotissement ou copro ?"
        ];

        const pointsPC = [
            "Contrôle implantation : distance aux voisins",
            "Contrôle des accés : recule 5m, poubelle, limite espace publique, cloture et traitement des limites …",
            "Contrôle des hauteurs / batis / annexes : Voiries (préciser hauteurs total ou égout)",
            "Contrôle des hauteurs / batis / annexes : limite séparative (préciser hauteurs total ou égout)",
            "Contrôle des hauteurs / batis / annexes : entre batis (préciser hauteurs total ou égout)",
            "Contrôle Emprise", 
            "/ Surface espace vert", 
            "Surface imperméable", 
            "SdP", 
            "Surface parcelle",
            "Surface max autorisée", 
            "Contrôle stationenment, vélo, moto (préciser nombre place)",
            "Gestion EP : calcule selon surface (rappel régle noue, bassin…)",
            "Les raccrodements EDF, télécom, EU, AEP,...",
            "Vérification des cotes présentes en PM, en coupe, en facade : indiquer les NGF et le delta par rapport au TN",
            "Sujet gypse", 
            "Sujet gaz", 
            "Sujet AZAP", 
            "Sujet ZPPAUP", 
            "Sujet Feu", 
            "Sujet Inondable",
            "Sujet mixité sociale", 
            "Vérification de l'ensemble des surfaces terrain (terrain, bâti existant, extension, emprise, surface imperméabilisée)"
        ];

        const DRIVE_LINK = "https://drive.google.com/drive/folders/1f4kJQj3CJIKSzggXc36FxPJ0jbDdDS8d?usp=drive_link";

        let database = JSON.parse(localStorage.getItem('pujol_database')) || [];
        let currentEditingId = null;

        // --- GÉNÉRATION UI ---
        function createItems(list, containerId, prefix) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            list.forEach((point, i) => {
                const id = `${prefix}-${i+1}`;
                const isCritical = point.toLowerCase().includes("inondation") || point.toLowerCase().includes("feu de forêt") || point.toLowerCase().includes("surface max");
                container.innerHTML += `
                    <div class="control-item ${isCritical ? 'border-orange-200 bg-orange-50/20' : ''}">
                        <div class="flex items-start gap-3">
                            <input type="checkbox" id="${id}" onchange="updateProgress(); saveCurrentAudit()" class="checkbox-custom mt-1 h-5 w-5 rounded text-emerald-500 border-slate-300">
                            <div class="flex-1">
                                <label for="${id}" class="text-xs text-slate-700 font-bold cursor-pointer block mb-1">
                                    ${i+1}) ${point}
                                </label>
                                <textarea id="${id}-note" oninput="saveCurrentAudit()" class="note-field" rows="1" placeholder="Note technique..."></textarea>
                            </div>
                        </div>
                    </div>`;
            });
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.getElementById('btn-infos').classList.toggle('tab-active', tabId === 'tab-infos');
            document.getElementById('btn-controle').classList.toggle('tab-active', tabId === 'tab-controle');
            document.getElementById('btn-suivi').classList.toggle('tab-active', tabId === 'tab-suivi');
            if(tabId === 'tab-suivi') renderSuivi();
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function saveCurrentAudit() {
            const audit = {
                id: document.getElementById('proj-dossier').value || 'TEMP-' + Date.now(),
                header: {
                    name: document.getElementById('proj-name').value,
                    dossier: document.getElementById('proj-dossier').value,
                    agent: document.getElementById('proj-agent').value,
                    sdp: document.getElementById('proj-sdp').value,
                    date: document.getElementById('proj-date').value,
                    notes: document.getElementById('notes').value
                },
                checks: {}
            };
            document.querySelectorAll('.checkbox-custom').forEach(cb => {
                audit.checks[cb.id] = { checked: cb.checked, note: document.getElementById(cb.id + '-note').value };
            });
            localStorage.setItem('pujol_current_audit', JSON.stringify(audit));
            updateProgress();
        }

        function updateProgress() {
            const total = document.querySelectorAll('.checkbox-custom').length;
            if(total === 0) return;
            const checked = document.querySelectorAll('.checkbox-custom:checked').length;
            const pct = Math.round((checked / total) * 100);
            document.getElementById('progress-bar').style.width = pct + '%';
            document.getElementById('progress-text').innerText = pct + '%';
        }

        function generateCSV(audit) {
            let csv = "\uFEFF"; 
            csv += "RAPPORT DE FAISABILITE - PUJOL ARCHITECTURE\n";
            csv += `Dossier;${audit.header.dossier}\nProjet;${audit.header.name}\nAgent;${audit.header.agent}\nSdP;${audit.header.sdp}\nDate;${audit.header.date}\n\n`;
            csv += "SECTION;POINT;VALIDE;NOTE\n";
            pointsAC.forEach((p, i) => {
                const data = audit.checks[`ac-${i+1}`] || { checked: false, note: "" };
                csv += `Auto-Controle;${p};${data.checked ? 'OUI' : 'NON'};${data.note.replace(/;/g, ',')}\n`;
            });
            pointsPC.forEach((p, i) => {
                const data = audit.checks[`pc-${i+1}`] || { checked: false, note: "" };
                csv += `Administratif;${p};${data.checked ? 'OUI' : 'NON'};${data.note.replace(/;/g, ',')}\n`;
            });
            csv += `\nSYNTHESE GENERALE;${(audit.header.notes || "").replace(/\n/g, ' ')}`;
            return csv;
        }

        function triggerDownload(audit) {
            if(!audit.header.dossier) return null;
            const csv = generateCSV(audit);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            const fileName = `Audit_${audit.header.dossier}_${audit.header.name || 'Projet'}.csv`.replace(/[^a-z0-9]/gi, '_');
            link.setAttribute("href", url);
            link.setAttribute("download", fileName + ".csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            return fileName + ".csv";
        }

        function validateAndArchive() {
            const dossierNum = document.getElementById('proj-dossier').value.trim();
            if(!dossierNum) { alert("Numéro de dossier requis !"); switchTab('tab-infos'); return; }

            const current = JSON.parse(localStorage.getItem('pujol_current_audit'));
            
            // 1. Download immédiat
            const fileName = triggerDownload(current);

            // 2. Archivage base locale
            const index = database.findIndex(d => d.id === dossierNum);
            const dossierData = {
                id: dossierNum,
                audit: current,
                tracking: index >= 0 ? database[index].tracking : {
                    managerControl: false, realizationDelay: '', estSubDate: '', realSubDate: '', subNumber: '',
                    extraDocsReq: false, extraDocsDelay: '', docsControl: false, docsSubDate: '',
                    instructionDelay: '', granted: false, remarks: ''
                },
                lastEdit: new Date().toISOString()
            };
            if(index >= 0) database[index] = dossierData; else database.push(dossierData);
            localStorage.setItem('pujol_database', JSON.stringify(database));

            // 3. UI Feedback
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-message');
            toast.style.opacity = '1'; toast.style.pointerEvents = 'auto';
            toastMsg.innerHTML = `<strong class="text-white">Dossier "${fileName}" enregistré et téléchargé.</strong><br>Lancement du mail et ouverture du Drive...<br><br>⚠️ N'oubliez pas d'attacher le fichier Excel téléchargé au mail.`;

            // 4. Sequence d'ouverture Mail et Drive
            setTimeout(() => {
                // Ouverture Drive
                window.open(DRIVE_LINK, "_blank");

                // Préparation du mail
                const subject = `Analyse Faisabilité : ${dossierNum} - ${current.header.name}`;
                let body = `Bonjour,\n\nVeuillez trouver ci-joint l'analyse de faisabilité pour le projet suivant :\n\n`;
                body += `PROJET : ${current.header.name}\n`;
                body += `DOSSIER : ${dossierNum}\n`;
                body += `AGENT : ${current.header.agent}\n`;
                body += `SdP : ${current.header.sdp} m2\n\n`;
                body += `SYNTHÈSE :\n${current.header.notes || 'N/A'}\n\n`;
                body += `--------------------------------------------------\n`;
                body += `REMARQUE : Le fichier Excel "${fileName}" vient d'être téléchargé sur mon poste. Je le joins manuellement à cet envoi.\n`;
                body += `Lien de sauvegarde Drive : ${DRIVE_LINK}\n`;
                body += `--------------------------------------------------\n`;
                body += `Fin du rapport - Pujol Archi 2026.`;
                
                // Lancement application mail
                window.location.href = `mailto:contact@pujol-archi.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                setTimeout(() => { 
                    toast.style.opacity = '0'; toast.style.pointerEvents = 'none'; 
                    switchTab('tab-suivi');
                }, 3000);
            }, 1500);
        }

        // --- FONCTIONS DE SUIVI ---
        function renderSuivi() {
            const list = document.getElementById('suivi-list');
            const stats = document.getElementById('stats-suivi');
            list.innerHTML = '';
            const sortedDb = [...database].sort((a, b) => new Date(b.lastEdit) - new Date(a.lastEdit));

            if(sortedDb.length === 0) {
                list.innerHTML = `<div class="p-12 text-center text-slate-400 border-2 border-dashed border-slate-200 rounded-3xl">Aucun dossier dans la base.</div>`;
            }

            sortedDb.forEach(d => {
                const isGranted = d.tracking.granted;
                const color = isGranted ? 'border-emerald-500' : (d.tracking.extraDocsReq ? 'border-orange-500' : 'border-slate-300');
                list.innerHTML += `
                    <div class="tracking-card ${color}" onclick="openSuiviEditor('${d.id}')">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-[10px] font-mono font-bold px-2 py-0.5 bg-slate-100 text-slate-600 rounded">${d.id}</span>
                                    ${isGranted ? '<span class="text-[9px] font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded uppercase tracking-wider">Accordé</span>' : ''}
                                </div>
                                <h4 class="text-lg font-bold text-slate-800">${d.audit.header.name || 'Sans nom'}</h4>
                                <p class="text-xs text-slate-500 font-medium">Réalisé par : ${d.audit.header.agent || 'N/C'} • Modifié le : ${new Date(d.lastEdit).toLocaleDateString()}</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="text-right hidden sm:block">
                                    <p class="text-[9px] uppercase font-bold text-slate-400">Dépôt Réel</p>
                                    <p class="text-sm font-mono font-bold text-slate-700">${d.tracking.realSubDate || '--/--/--'}</p>
                                </div>
                                <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:text-emerald-500 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                                </div>
                            </div>
                        </div>
                    </div>`;
            });

            stats.innerHTML = `
                <div class="bg-white px-4 py-2 rounded-xl shadow-sm border border-slate-200 text-center">
                    <p class="text-[9px] uppercase font-bold text-slate-400">Dossiers</p>
                    <p class="text-lg font-black text-slate-800">${database.length}</p>
                </div>`;
        }

        function openSuiviEditor(id) {
            const dossier = database.find(d => d.id === id);
            if(!dossier) return;
            currentEditingId = id;

            document.getElementById('edit-name').innerText = dossier.audit.header.name || id;
            document.getElementById('edit-agent').value = dossier.audit.header.agent || "";
            
            const t = dossier.tracking;
            document.getElementById('edit-manager-control').checked = t.managerControl || false;
            document.getElementById('edit-delai-real').value = t.realizationDelay || '';
            document.getElementById('edit-date-estim').value = t.estSubDate || '';
            document.getElementById('edit-date-reel').value = t.realSubDate || '';
            document.getElementById('edit-num-depot').value = t.subNumber || '';
            document.getElementById('edit-pc-req').checked = t.extraDocsReq || false;
            document.getElementById('edit-pc-delai').value = t.extraDocsDelay || '';
            document.getElementById('edit-pc-control').checked = t.docsControl || false;
            document.getElementById('edit-pc-date').value = t.docsSubDate || '';
            document.getElementById('edit-instruction-delai').value = t.instructionDelay || '';
            document.getElementById('edit-granted').checked = t.granted || false;
            document.getElementById('edit-remarks').value = t.remarks || '';

            document.getElementById('suivi-list').classList.add('hidden');
            document.getElementById('suivi-editor').classList.remove('hidden');
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function closeSuiviEditor() {
            document.getElementById('suivi-editor').classList.add('hidden');
            document.getElementById('suivi-list').classList.remove('hidden');
            currentEditingId = null;
        }

        function saveSuiviEdition() {
            const index = database.findIndex(d => d.id === currentEditingId);
            if(index < 0) return;

            database[index].tracking = {
                managerControl: document.getElementById('edit-manager-control').checked,
                realizationDelay: document.getElementById('edit-delai-real').value,
                estSubDate: document.getElementById('edit-date-estim').value,
                realSubDate: document.getElementById('edit-date-reel').value,
                subNumber: document.getElementById('edit-num-depot').value,
                extraDocsReq: document.getElementById('edit-pc-req').checked,
                extraDocsDelay: document.getElementById('edit-pc-delai').value,
                docsControl: document.getElementById('edit-pc-control').checked,
                docsSubDate: document.getElementById('edit-pc-date').value,
                instructionDelay: document.getElementById('edit-instruction-delai').value,
                granted: document.getElementById('edit-granted').checked,
                remarks: document.getElementById('edit-remarks').value
            };
            database[index].lastEdit = new Date().toISOString();

            localStorage.setItem('pujol_database', JSON.stringify(database));
            renderSuivi();
            closeSuiviEditor();
        }

        function deleteDossier() {
            if(confirm("Supprimer définitivement ce dossier ?")) {
                database = database.filter(d => d.id !== currentEditingId);
                localStorage.setItem('pujol_database', JSON.stringify(database));
                renderSuivi();
                closeSuiviEditor();
            }
        }

        function exportToExcel() {
            if(database.length === 0) return alert("Aucune donnée à exporter.");
            let csv = "\uFEFF"; 
            csv += "ID Dossier;Projet;Realise par;Derniere Modification;Controle Direction;Delai Realisation;Depot Estime;Depot Reel;Num Depot;PC Demandees;Delai PC;Controle PC;Date Depot PC;Delai Instruction;Accorde;Remarques\n";
            
            database.forEach(d => {
                const t = d.tracking;
                const h = d.audit.header;
                const row = [
                    d.id, h.name, h.agent, new Date(d.lastEdit).toLocaleDateString(),
                    t.managerControl ? "OK" : "NON", t.realizationDelay, t.estSubDate, t.realSubDate, t.subNumber,
                    t.extraDocsReq ? "OUI" : "NON", t.extraDocsDelay, t.docsControl ? "OK" : "NON", t.docsSubDate,
                    t.instructionDelay, t.granted ? "OUI" : "NON", (t.remarks || "").replace(/;/g, ",").replace(/\n/g, " ")
                ];
                csv += row.join(';') + "\n";
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Recap_Suivi_PujolArchi_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();

            setTimeout(() => {
                if(confirm("Récapitulatif exporté. Souhaitez-vous ouvrir le dossier Drive pour y déposer le fichier ?")) {
                    window.open(DRIVE_LINK, "_blank");
                }
            }, 500);
        }

        function createNewDossier() {
            if(confirm("Démarrer un nouvel audit ?")) {
                localStorage.removeItem('pujol_current_audit');
                location.reload();
            }
        }

        function exportCurrentToExcel() {
            const saved = localStorage.getItem('pujol_current_audit');
            if(saved) {
                const audit = JSON.parse(saved);
                const fileName = triggerDownload(audit);
                if(fileName) {
                    setTimeout(() => {
                        if(confirm(`Fichier "${fileName}" téléchargé. Souhaitez-vous ouvrir le dossier Drive pour l'archiver ?`)) {
                            window.open(DRIVE_LINK, "_blank");
                        }
                    }, 500);
                }
            }
        }

        window.onload = () => {
            createItems(pointsAC, 'section-ac', 'ac');
            createItems(pointsPC, 'section-pc', 'pc');
            document.getElementById('proj-date').valueAsDate = new Date();
            const saved = localStorage.getItem('pujol_current_audit');
            if(saved) {
                const data = JSON.parse(saved);
                document.getElementById('proj-name').value = data.header.name || "";
                document.getElementById('proj-dossier').value = data.header.dossier || "";
                document.getElementById('proj-agent').value = data.header.agent || "";
                document.getElementById('proj-sdp').value = data.header.sdp || "";
                document.getElementById('proj-date').value = data.header.date || "";
                document.getElementById('notes').value = data.header.notes || "";
                for(let id in data.checks) {
                    const cb = document.getElementById(id);
                    const note = document.getElementById(id + '-note');
                    if(cb) cb.checked = data.checks[id].checked;
                    if(note) note.value = data.checks[id].note;
                }
            }
            updateProgress();
        };
    </script>
</body>
</html>
